<!DOCTYPE html>
<html>
<head>
    <title>Distributed Image Processing</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .stage-container,
        .completed-container {
            max-height: 260px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px;
            font-size: 14px;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f7f7f7;
            position: sticky;
            top: 0;
        }

        .btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-toggle {
            background: #e9e9e9;
            color: #333;
        }

        .job-card {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .thumb {
            max-width: 120px;
            display: block;
            margin-top: 6px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
<div class="container">
    <h1>Distributed Image Processing Dashboard</h1>
    <!-- Metrics -->
    <div class="card metrics-card">
        <div class="metrics-row">
            <div>
                <b>Jobs</b>:
                <span id="metric-active">0</span> active |
                <span id="metric-completed">0</span> completed
            </div>
            <div>
                <b>Workers</b>:
                <span id="metric-workers">0</span> total |
                <span id="metric-busy">0</span> busy |
                <span id="metric-idle">0</span> idle
            </div>
        </div>
    </div>

    <!-- Stage -->
    <div class="card">
        <h2>Stage Images</h2>
        <input type="file" id="imageInput" multiple>
        <p class="hint">
            Upload images, choose operations, then start all jobs together.
        </p>
    </div>

    <div class="card">
        <h2>Staged Jobs</h2>
        <div class="stage-container">
            <table>
                <thead>
                <tr>
                    <th>Filename</th>
                    <th>Operation</th>
                    <th>Remove</th>
                </tr>
                </thead>
                <tbody id="stagedTable"></tbody>
            </table>
        </div>
        <br>
        <button class="btn btn-primary" onclick="startAllJobs()">
            Start Processing All Jobs
        </button>
    </div>

    <!-- Running Jobs -->
    <div class="card">
        <h2>Running Jobs (<span id="runningCount">0</span>)</h2>
        <div id="runningJobs"></div>
    </div>

    <!-- Completed Jobs -->
    <div class="card">
        <h2>
            Completed Jobs (<span id="completedCount">0</span>)
            <button class="btn btn-toggle" onclick="toggleCompleted()">Toggle</button>
        </h2>
        <div id="completedJobs" class="completed-container hidden"></div>
    </div>

    <div class="card" style="padding: 12px 16px; background: #020617;">
        <div style="font-size: 14px; color: #e5e7eb;">
            <b>System Performance</b>
        </div>
        <div style="font-size: 13px; color: #94a3b8; margin-top: 6px; line-height: 1.8;">
            <div>
                <b style="color: #e5e7eb;">Live Throughput:</b> 
                <span id="metric-throughput">0</span> tiles/sec 
                <span style="font-size: 11px; opacity: 0.7;">(5-second window across all workers)</span>
            </div>
            <div>
                <b style="color: #e5e7eb;">Avg Job Time:</b> 
                <span id="metric-jobtime">0</span>s
            </div>
        </div>
    </div>

</div>

<script>
let stagedJobs = [];
let completedVisible = false;

// ---------- STAGING ----------
document.getElementById("imageInput").addEventListener("change", () => {
    const files = Array.from(imageInput.files);
    for (const file of files) {
        stagedJobs.push({ file, operation: "grayscale" });
    }
    imageInput.value = "";
    renderStagedJobs();
});

function renderStagedJobs() {
    const tbody = document.getElementById("stagedTable");
    tbody.innerHTML = "";

    stagedJobs.forEach((job, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${job.file.name}</td>
            <td>
                <select onchange="stagedJobs[${i}].operation=this.value">
                    <option value="grayscale">Grayscale</option>
                    <option value="blur">Blur</option>
                    <option value="edge">Edge</option>
                </select>
            </td>
            <td>
                <button class="btn" onclick="stagedJobs.splice(${i},1);renderStagedJobs()">X</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// ---------- SUBMIT ----------
function startAllJobs() {
    stagedJobs.forEach(job => submitJob(job.file, job.operation));
    stagedJobs = [];
    renderStagedJobs();
}

// ---------- JOBS ----------
function submitJob(file, operation) {
    const fd = new FormData();
    fd.append("file", file);

    fetch(`/upload?operation=${operation}`, {
        method: "POST",
        body: fd
    })
    .then(res => res.json())
    .then(data => {
        addRunningJob(data.job_id, file.name, operation);
        pollStatus(data.job_id);
    });
}

function addRunningJob(jobId, filename, operation) {
    const div = document.createElement("div");
    div.className = "job-card";
    div.id = `job-${jobId}`;
    div.innerHTML = `
        <b>${filename}</b> (${operation})<br>
        <span id="status-${jobId}">processing</span>
    `;
    runningJobs.prepend(div);
    updateCounts();
}

function pollStatus(jobId) {
    const interval = setInterval(async () => {
        const res = await fetch(`/status/${jobId}`);
        if (!res.ok) return;
        const data = await res.json();

        const statusEl = document.getElementById(`status-${jobId}`);
        if (!statusEl) return;

        statusEl.innerText = data.status;

        if (data.status === "completed") {
            clearInterval(interval);
            await moveToCompleted(jobId);
        }
    }, 1000);
}

async function moveToCompleted(jobId) {
    const card = document.getElementById(`job-${jobId}`);
    card.remove();

    // Fetch detailed metrics for this job
    const metricsRes = await fetch("/metrics");
    const metricsData = await metricsRes.json();
    
    const jobDetails = metricsData.jobs.details.find(j => j.job_id === jobId);
    
    let workerInfo = "";
    if (jobDetails && jobDetails.workers) {
        const workerEntries = Object.entries(jobDetails.workers);
        const throughput = (jobDetails.tiles / jobDetails.duration_sec).toFixed(1);
        workerInfo = `
            <div style="font-size: 11px; margin-top: 8px; padding: 8px; background: #020617; border-radius: 4px; color: #94a3b8; line-height: 1.8;">
                <div><b style="color: #e5e7eb;">Duration:</b> ${jobDetails.duration_sec}s | <b style="color: #e5e7eb;">Tiles:</b> ${jobDetails.tiles} | <b style="color: #e5e7eb;">Throughput:</b> ${throughput} tiles/s</div>
                <div><b style="color: #e5e7eb;">Avg tile time:</b> ${jobDetails.avg_tile_time_ms}ms</div>
                <div><b style="color: #e5e7eb;">Workers:</b> ${workerEntries.map(([w, count]) => `${w}: ${count} tiles`).join(", ")}</div>
            </div>
        `;
    }

    const div = document.createElement("div");
    div.className = "job-card";
    div.innerHTML = `
        <b>Job ${jobId.slice(0,8)}</b>
        ${workerInfo}
        <img class="thumb" src="/result/${jobId}?t=${Date.now()}">
    `;
    completedJobs.prepend(div);
    updateCounts();
}

function toggleCompleted() {
    completedVisible = !completedVisible;
    completedJobs.classList.toggle("hidden", !completedVisible);
}

function updateCounts() {
    runningCount.innerText = runningJobs.children.length;
    completedCount.innerText = completedJobs.children.length;
}

async function pollMetrics() {
    try {
        const res = await fetch("/metrics");
        if (!res.ok) return;

        const data = await res.json();

        // Jobs
        document.getElementById("metric-active").innerText = data.jobs.active;
        document.getElementById("metric-completed").innerText = data.jobs.completed;

        // Workers
        document.getElementById("metric-workers").innerText = data.workers.total;
        document.getElementById("metric-busy").innerText = data.workers.busy;
        document.getElementById("metric-idle").innerText = data.workers.idle;

        if (data.performance) {
            document.getElementById("metric-throughput").innerText =
                data.performance.tiles_per_sec;

            document.getElementById("metric-jobtime").innerText =
                data.performance.avg_job_time_sec;
        }

    } catch (e) {
        console.warn("Metrics fetch failed");
    }
}

// Poll every 2 seconds
setInterval(pollMetrics, 2000);
pollMetrics();

</script>
</body>
</html>
